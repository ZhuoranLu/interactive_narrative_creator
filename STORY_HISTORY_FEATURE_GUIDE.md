# 📚 故事编辑历史与回滚功能指南

## 🎯 功能概述

新的故事编辑历史功能允许用户在编辑故事时自动创建历史快照，并支持回滚到之前的任意状态。这确保了编辑过程的安全性，用户可以放心地尝试各种编辑而不用担心丢失之前的工作。

### ✨ 主要特性

- **自动快照创建**：每次编辑操作（编辑场景、添加/删除事件、添加/删除动作）前自动创建快照
- **最多保存5个历史状态**：自动清理旧的历史记录，保持性能
- **一键回滚**：可以回滚到任意历史状态
- **详细操作记录**：显示每个操作的时间、类型和描述
- **可视化历史面板**：直观的界面显示编辑历史

## 🚀 如何使用

### 1. 激活历史功能

1. 打开任意项目的故事树视图
2. 您会看到两个回滚按钮：
   - **🔄 撤销上一步** - 在主界面顶部，快速回滚到上一个编辑状态
   - **📚 编辑历史** - 在故事树右上角，查看完整编辑历史

### 2. 快速回滚（推荐）

**位置**：主界面顶部的按钮栏
- **🔄 撤销上一步** 按钮 - 橙色按钮，非常醒目
- 点击后会询问是否确认回滚
- 自动回滚到上一个编辑状态
- 适合快速撤销最近的错误操作

### 3. 查看完整编辑历史

**位置**：故事树可视化界面的右上角
- 点击 **📚 编辑历史** 按钮（蓝色）
- 历史面板将显示在右侧，包含：
  - **最新状态**：标记为 "当前状态" 的绿色标签
  - **操作类型**：📝 编辑场景、➕ 添加事件、⚡ 添加动作等
  - **操作描述**：具体的编辑内容描述
  - **时间戳**：操作执行的准确时间
  - **节点信息**：受影响的节点ID

### 4. 执行精确回滚操作

在编辑历史面板中：
1. 找到想要回滚到的状态
2. 点击该状态右下角的 **"🔄 回滚到此"** 按钮
3. 确认回滚操作（这将撤销该状态之后的所有更改）
4. 系统会自动重新加载故事树，显示回滚后的状态

### 5. 管理历史记录

- **删除记录**：点击 "🗑️ 删除" 按钮可以删除不需要的历史记录
- **刷新历史**：点击标题栏的 "🔄" 按钮刷新历史记录
- **关闭面板**：点击 "✕" 按钮或再次点击 "📚 编辑历史" 按钮

## 📍 回滚按钮位置图解

```
主界面布局:
┌─────────────────────────────────────────────────────────┐
│ 📚 Interactive Narrative Creator                        │
│                                                         │
│ [Bootstrap] [Continue] ... [🔄 撤销上一步] ← 主要回滚按钮 │
│                                                         │
│ 💡 编辑历史功能：                                        │
│ • 🔄 撤销上一步 - 快速回滚到上一个编辑状态               │
│ • 📚 编辑历史 - 查看完整编辑历史                        │
│                                                         │
│ ┌─ Story Tree Visualization ──────────────── [📚 编辑历史] │
│ │  [Node] ──→ [Node] ──→ [Node]                        │
│ │     │          │          │                          │
│ │  [Node]    [Node]     [Node]                        │
│ └─────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘

历史面板布局:
┌──────────────────────┐
│ 📚 编辑历史记录  🔄 ✕ │
├──────────────────────┤
│ 📝 EDIT_SCENE [当前]  │
│ 编辑节点: 主角走进...  │
│ 2024-01-15 14:30:25  │
│                      │
│ ➕ ADD_EVENT         │
│ 添加对话: "你好..."   │
│ 2024-01-15 14:28:10  │
│          [🔄回滚][🗑️] │
└──────────────────────┘
```

## 📋 支持的操作类型

| 操作类型 | 图标 | 描述 | 自动创建快照 |
|---------|------|------|-------------|
| **编辑场景** | 📝 | 修改节点的场景描述 | ✅ |
| **添加事件** | ➕ | 向节点添加新的对话或事件 | ✅ |
| **删除事件** | 🗑️ | 从节点删除事件 | ✅ |
| **添加动作** | ⚡ | 向节点添加新的用户动作 | ✅ |
| **删除动作** | ❌ | 从节点删除动作 | ✅ |
| **更新事件** | ✏️ | 修改现有事件内容 | ✅ |
| **更新动作** | 🔧 | 修改现有动作描述 | ✅ |
| **回滚点** | 🔄 | 回滚操作前的状态保存 | 自动 |

## 🔧 技术实现

### 后端架构

```
React 前端 → FastAPI API → 历史快照存储 → SQLite/PostgreSQL 数据库
```

### 关键组件

1. **StoryEditHistory 数据表**：存储历史快照
2. **StoryHistoryRepository**：管理历史操作的数据访问层
3. **History API 端点**：提供历史管理的REST接口
4. **StoryHistoryPanel 组件**：React前端历史界面

### API 端点

- `GET /projects/{project_id}/history` - 获取项目历史
- `POST /projects/{project_id}/history/snapshot` - 创建快照
- `POST /projects/{project_id}/history/rollback` - 执行回滚
- `DELETE /projects/{project_id}/history/{snapshot_id}` - 删除快照

## 🎨 用户界面说明

### 历史面板布局

```
┌─────────────────────────────┐
│ 📚 编辑历史记录      🔄  ✕  │
├─────────────────────────────┤
│ 📝 EDIT_SCENE  [当前状态]   │
│ 编辑节点: 主角走进了房间...  │
│ 2024-01-15 14:30:25        │
│                             │
│ ➕ ADD_EVENT               │
│ 添加对话: "你好，欢迎来到..."│
│ 2024-01-15 14:28:10        │
│                  🔄 🗑️     │
│                             │
│ ⚡ ADD_ACTION              │
│ 添加动作: 查看房间          │
│ 2024-01-15 14:25:45        │
│                  🔄 🗑️     │
├─────────────────────────────┤
│ 💡 最多保存5条历史记录      │
└─────────────────────────────┘
```

### 状态指示器

- **🟢 当前状态**：最新的编辑状态
- **🔵 历史状态**：可以回滚到的之前状态
- **🟡 加载中**：正在处理回滚或加载历史
- **🔴 错误状态**：操作失败的提示

## ⚡ 性能优化

### 自动清理机制

- 每个项目最多保存 **5个历史快照**
- 创建新快照时自动删除最旧的记录
- 保持数据库大小合理，确保查询性能

### 快照策略

- **仅在实际更改时创建快照**：避免重复的无意义快照
- **批量操作优化**：多个小更改会合并为一个快照
- **异步处理**：快照创建不阻塞主要编辑流程

## 🛡️ 安全性考虑

### 权限控制

- 只有项目所有者可以查看和管理历史记录
- 历史记录与用户账户绑定，确保隐私
- 所有API调用都需要有效的JWT认证

### 数据保护

- 快照数据使用JSON格式存储，便于版本控制
- 回滚操作前会自动创建"回滚点"，支持撤销回滚
- 删除操作有确认对话框，防止意外删除

## 🐛 故障排除

### 常见问题

**Q: 历史面板显示空白**
- A: 确认项目已正确加载，且您有访问权限
- A: 尝试点击刷新按钮重新加载历史记录

**Q: 回滚操作失败**
- A: 检查网络连接是否正常
- A: 确认您有该项目的编辑权限
- A: 尝试刷新页面重新登录

**Q: 快照创建失败**
- A: 通常快照创建失败不会影响主要编辑功能
- A: 检查浏览器控制台的错误信息
- A: 确认服务器运行正常

**Q: 历史记录丢失**
- A: 历史记录会自动清理，只保留最新的5个状态
- A: 检查是否有其他用户也在编辑同一项目

### 调试技巧

1. **打开浏览器开发者工具**
   - Network标签页查看API请求状态
   - Console标签页查看JavaScript错误

2. **检查服务器日志**
   - FastAPI服务器控制台输出
   - 数据库连接状态

3. **验证用户权限**
   - 确认已正确登录
   - 检查项目所有权

## 🚀 高级使用技巧

### 工作流建议

1. **重要编辑前手动创建快照**
   - 在进行大型更改前，先进行小型编辑以创建快照
   - 为重要的编辑里程碑添加描述性的操作说明

2. **合理使用回滚功能**
   - 回滚到最近的稳定状态，而不是过于久远的历史
   - 回滚后立即验证故事逻辑的完整性

3. **历史记录管理**
   - 定期清理不需要的历史记录以保持列表整洁
   - 对重要的历史状态可以先导出备份再删除

### 最佳实践

- **渐进式编辑**：进行小步骤的编辑，便于精确回滚
- **描述性操作**：系统会自动生成操作描述，但可以通过编辑内容让描述更清晰
- **及时保存**：每次重要编辑后点击保存，确保快照创建
- **团队协作**：在多人协作时，定期同步历史状态

## 📊 使用统计

通过历史面板，您可以了解：
- 编辑频率和模式
- 最常使用的操作类型
- 故事发展的时间线
- 编辑效率指标

这些信息有助于优化您的故事创作工作流程。

---

**💡 提示**：历史功能是为了增强创作安全性和便利性。合理使用此功能可以让您在故事创作中更加大胆和富有创造性！ 