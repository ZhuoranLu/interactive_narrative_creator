# 实时数据库同步功能测试指南

## 概述

本指南说明如何测试React前端与FastAPI后端的实时数据库同步功能。

## 测试步骤

### 1. 启动后端服务器

```bash
cd server
python -m uvicorn app.main:app --reload
```

### 2. 启动前端应用

```bash
cd interactive_narrative
npm start
```

### 3. 用户认证测试

1. 访问 `http://localhost:3000`
2. 注册新用户账户
3. 登录账户

### 4. 项目和故事树测试

1. 创建新项目或加载已有项目
2. 确保故事树正确显示

### 5. 实时编辑测试

#### 测试场景文本编辑：
1. 点击任意节点
2. 修改场景文本
3. 点击 "Save & Sync to Database"
4. **验证**：编辑对话框关闭后，节点应立即显示更新后的文本（无需刷新页面）

#### 测试事件编辑：
1. 在编辑对话框中添加新的对话事件
2. 填写 Speaker 和 Content
3. 点击保存
4. **验证**：事件应立即出现在节点数据中

#### 测试动作编辑：
1. 添加新动作
2. 编辑现有动作描述
3. 切换 "Key Action" 状态
4. 删除动作
5. **验证**：所有更改应立即反映在界面上

### 6. 数据持久化测试

1. 进行上述编辑操作
2. 刷新浏览器页面
3. 重新加载项目
4. **验证**：所有更改都应该从数据库中正确恢复

### 7. 错误处理测试

1. 断开网络连接
2. 尝试编辑和保存
3. **验证**：应显示错误消息
4. 恢复网络连接
5. 再次保存
6. **验证**：应成功同步

## 预期行为

### ✅ 成功指标

- [ ] 编辑后立即看到UI更新（无需刷新页面）
- [ ] 同步状态消息正确显示
- [ ] 页面刷新后更改仍然存在
- [ ] 多个用户编辑不同项目不会互相干扰
- [ ] 网络错误时显示适当的错误消息

### ❌ 问题指标

- [ ] 编辑后需要刷新页面才能看到更改
- [ ] 保存后数据丢失
- [ ] 错误消息不清楚或缺失
- [ ] UI冻结或响应缓慢

## 调试工具

### 浏览器开发者工具

1. 打开 Network 标签页查看API请求
2. 查看 Console 了解状态更新日志
3. 使用 React DevTools 检查组件状态

### 后端日志

检查FastAPI服务器日志以确认：
- API请求正确接收
- 数据库操作成功执行
- 认证和权限验证正常

## 常见问题排除

### 问题：编辑后UI不更新

**可能原因**：
- `onNodeUpdate` 回调未正确传递
- 父组件状态更新逻辑有误
- React状态不可变性违反

**解决方案**：
检查 `NarrativeClient.tsx` 中的 `handleNodeUpdate` 函数

### 问题：数据未保存到数据库

**可能原因**：
- 认证令牌过期
- 网络连接问题
- 后端API错误

**解决方案**：
检查浏览器Network标签页和后端日志

### 问题：权限错误

**可能原因**：
- 用户尝试编辑非自己拥有的项目
- JWT令牌问题

**解决方案**：
确认用户已正确登录且项目归属正确

## API端点测试

可以使用以下工具直接测试API：

### 使用curl测试

```bash
# 获取认证令牌
curl -X POST "http://localhost:8000/auth/login" \
     -H "Content-Type: application/json" \
     -d '{"username": "your_username", "password": "your_password"}'

# 更新节点
curl -X PUT "http://localhost:8000/nodes/node_id" \
     -H "Authorization: Bearer YOUR_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"scene": "Updated scene text"}'
```

### 使用Python脚本测试

参考 `test_database_sync_api.py` 进行全面的API测试。

## 性能考虑

- 批量更新比单个更新更高效
- 大型故事树可能需要优化渲染
- 网络延迟可能影响用户体验

## 安全考虑

- 所有API调用都需要有效的JWT认证
- 用户只能编辑自己拥有的项目
- 输入验证在前端和后端都进行 